<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Make (tjr_kv.Tjr_kv__Synchronous_store.Make)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="generator" content="doc-ock-html v1.0.0-1-g1fc9bf0"/></head><body><nav id="top"><a href="../index.html">Up</a> &mdash; <span class="package">package <a href="../../index.html">tjr_kv</a></span></nav><header><h1><span class="keyword">Module</span> <span class="module-path">Tjr_kv__Synchronous_store.Make</span></h1></header><h3 class="heading">Parameters</h3><div><div class="spec argument" id="argument-1-Requires"><a href="#argument-1-Requires" class="anchor"></a><div class="def argument"><code><a href="argument-1-Requires/index.html">Requires</a> : <a href="../index.html#module-type-REQUIRES">REQUIRES</a></code></div><div class="doc"></div></div></div><h3 class="heading">Signature</h3><div class="spec type" id="type-bt_blk_id"><a href="#type-bt_blk_id" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>bt_blk_id</code><code><span class="keyword"> = </span><a href="argument-1-Requires/Bt_blk_id/index.html#type-t">Requires.Bt_blk_id.t</a></code><code></code></div><div class="doc"></div></div><div class="spec type" id="type-pc_blk_id"><a href="#type-pc_blk_id" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>pc_blk_id</code><code><span class="keyword"> = </span><a href="argument-1-Requires/Pc_blk_id/index.html#type-t">Requires.Pc_blk_id.t</a></code><code></code></div><div class="doc"></div></div><div class="spec type" id="type-root_pair"><a href="#type-root_pair" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>root_pair</code><code></code><code><span class="keyword"> = </span></code><code>{</code><table class="record"><tr id="type-root_pair.pcache_root" class="anchored"><td class="def field"><a href="#type-root_pair.pcache_root" class="anchor"></a><code>pcache_root : <a href="index.html#type-pc_blk_id">pc_blk_id</a>;</code></td></tr><tr id="type-root_pair.btree_root" class="anchored"><td class="def field"><a href="#type-root_pair.btree_root" class="anchor"></a><code>btree_root : <a href="index.html#type-bt_blk_id">bt_blk_id</a>;</code></td></tr></table><code>}</code><code></code></div><div class="doc"><p>We execute a roll up in another thread, to avoid blocking the
pcache. The roll-up thread will typically finish with a new pair
of roots.</p></div></div><div class="spec val" id="val-execute_btree_rollup"><a href="#val-execute_btree_rollup" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>execute_btree_rollup : monad_ops:<span class="type-var">'t</span> <a href="../../../tjr_monad/Tjr_monad/Types/index.html#type-monad_ops">Tjr_monad.Types.monad_ops</a> <span class="keyword">&#8209;&gt;</span> bt_insert:(<span class="type-var">'k</span> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'v</span> <span class="keyword">&#8209;&gt;</span> (unit, <span class="type-var">'t</span>) <a href="../../../tjr_monad/Tjr_monad/Types/index.html#type-m">Tjr_monad.Types.m</a>) <span class="keyword">&#8209;&gt;</span> bt_delete:(<span class="type-var">'k</span> <span class="keyword">&#8209;&gt;</span> (unit, <span class="type-var">'t</span>) <a href="../../../tjr_monad/Tjr_monad/Types/index.html#type-m">Tjr_monad.Types.m</a>) <span class="keyword">&#8209;&gt;</span> bt_sync:(unit <span class="keyword">&#8209;&gt;</span> (<a href="index.html#type-bt_blk_id">bt_blk_id</a>, <span class="type-var">'t</span>) <a href="../../../tjr_monad/Tjr_monad/Types/index.html#type-m">Tjr_monad.Types.m</a>) <span class="keyword">&#8209;&gt;</span> kvop_map_bindings:(<span class="type-var">'op_map</span> <span class="keyword">&#8209;&gt;</span> (<span class="type-var">'k</span>, <span class="type-var">'v</span>) <a href="../../../tjr_pcache/Tjr_pcache/Ins_del_op_type/index.html#type-op">Tjr_pcache.Ins_del_op_type.op</a> list) <span class="keyword">&#8209;&gt;</span> sync_new_roots:(<a href="index.html#type-root_pair">root_pair</a> <span class="keyword">&#8209;&gt;</span> (unit, <span class="type-var">'t</span>) <a href="../../../tjr_monad/Tjr_monad/Types/index.html#type-m">Tjr_monad.Types.m</a>) <span class="keyword">&#8209;&gt;</span> (<a href="index.html#type-pc_blk_id">pc_blk_id</a>, <span class="type-var">'op_map</span>) <a href="../../../tjr_pcache/Tjr_pcache/Detachable_chunked_list/index.html#type-detach_result">Tjr_pcache.Detachable_chunked_list.detach_result</a> <span class="keyword">&#8209;&gt;</span> (unit, <span class="type-var">'t</span>) <a href="../../../tjr_monad/Tjr_monad/Types/index.html#type-m">Tjr_monad.Types.m</a></code></div><div class="doc"><p>This should execute in another dedicated rollup thread, so that
the pcache thread is not blocked. We can't just instantiate this
function here. In the pcache thread we need to join a msg to the
end of a msg queue, signalling the rollup thread to perform a
rollup. In this case, the rollup thread likely already knows
operations such as <code class="code">bt_insert</code> etc. which it can use to
instantiate this function.</p><p>NOTE that we return a unit so that from the pcache we can call
this function without waiting for the rollup to occur. So the new
roots have to be handled somewhere else (not in the pcache
thread).</p></div></div><div class="spec type" id="type-ukv_ops"><a href="#type-ukv_ops" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>('k, 'v, 't) ukv_ops</code><code><span class="keyword"> = </span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>, <span class="type-var">'t</span>) <a href="../../../tjr_btree/Tjr_btree/Map_ops/index.html#type-map_ops">Tjr_btree.Map_ops.map_ops</a></code><code></code></div><div class="doc"></div></div><div class="spec val" id="val-make_ukv_ops"><a href="#val-make_ukv_ops" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>make_ukv_ops : monad_ops:<span class="type-var">'t</span> <a href="../../../tjr_monad/Tjr_monad/Types/index.html#type-monad_ops">Tjr_monad.Types.monad_ops</a> <span class="keyword">&#8209;&gt;</span> pcache_ops:(<span class="type-var">'k</span>, <span class="type-var">'v</span>, <span class="type-var">'a</span>, <span class="type-var">'b</span>, <span class="type-var">'t</span>) <a href="../../../tjr_pcache/Tjr_pcache/Detachable_chunked_list/index.html#type-dcl_ops">Tjr_pcache.Detachable_chunked_list.dcl_ops</a> <span class="keyword">&#8209;&gt;</span> pcache_blocks_limit:int <span class="keyword">&#8209;&gt;</span> bt_find:(<span class="type-var">'k</span> <span class="keyword">&#8209;&gt;</span> (<span class="type-var">'v</span> option, <span class="type-var">'t</span>) <a href="../../../tjr_monad/Tjr_monad/Types/index.html#type-m">Tjr_monad.Types.m</a>) <span class="keyword">&#8209;&gt;</span> execute_btree_rollup:((<span class="type-var">'b</span>, <span class="type-var">'a</span>) <a href="../../../tjr_pcache/Tjr_pcache/Detachable_chunked_list/index.html#type-detach_result">Tjr_pcache.Detachable_chunked_list.detach_result</a> <span class="keyword">&#8209;&gt;</span> (unit, <span class="type-var">'t</span>) <a href="../../../tjr_monad/Tjr_monad/Types/index.html#type-m">Tjr_monad.Types.m</a>) <span class="keyword">&#8209;&gt;</span> (<span class="type-var">'k</span>, <span class="type-var">'v</span>, <span class="type-var">'t</span>) <a href="index.html#type-ukv_ops">ukv_ops</a></code></div><div class="doc"><p>Construct the UKV. Parameters:
</p><ul><li><code class="code">monad_ops</code></li><li><code class="code">pcache_ops</code>: dcl_ops from tjr_pcache</li><li><code class="code">pcache_blocks_limit</code>: how many blocks in the pcache before attempting a roll-up; if the length of pcache is <code class="code">&gt;=</code> this limit, we attempt a roll-up; NOTE that this limit should be &gt;= 2 (if we roll up with 1 block, then in fact nothing gets rolled up because we roll up &quot;upto&quot; the current block; not a problem but probably pointless for testing)</li><li><code class="code">bt_find</code>: called if key not in pcache map FIXME do we need a write-through cache here? or just rely on the front-end LRU? FIXME note that even if a rollup is taking place, we can use the old B-tree root for the <code class="code">bt_find</code> operation.</li><li><code class="code">execute_btree_rollup</code>: called to detach the rollup into another thread; typically this operation puts a msg on a message queue which is then received and acted upon by the dedicated rollup thread</li></ul></div></div></body></html>