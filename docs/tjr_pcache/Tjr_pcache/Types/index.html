<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Types (tjr_pcache.Tjr_pcache.Types)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="generator" content="doc-ock-html v1.0.0-1-g1fc9bf0"/></head><body><nav id="top"><a href="../index.html">Up</a> &mdash; <span class="package">package <a href="../../index.html">tjr_pcache</a></span></nav><header><h1><span class="keyword">Module</span> <span class="module-path">Tjr_pcache.Types</span></h1></header><div class="spec include"><div class="doc"></div><details open="open"><summary><span class="def"><code><span class="keyword">include </span><a href="../index.html#module-Ins_del_op_type">Ins_del_op_type</a></code></span></summary><p>A concrete type for insert and delete operations</p><p>An op is either insert or delete. These are the entries that get
written to disk.</p><div class="spec type" id="type-op"><a href="#type-op" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>('k, 'v) op</code><code></code><code><span class="keyword"> = </span></code><table class="variant"><tr id="type-op.Insert" class="anchored"><td class="def constructor"><a href="#type-op.Insert" class="anchor"></a><code><span class="keyword">| </span></code><code><span class="constructor">Insert</span><span class="keyword"> of </span><span class="type-var">'k</span><span class="keyword"> * </span><span class="type-var">'v</span></code></td></tr><tr id="type-op.Delete" class="anchored"><td class="def constructor"><a href="#type-op.Delete" class="anchor"></a><code><span class="keyword">| </span></code><code><span class="constructor">Delete</span><span class="keyword"> of </span><span class="type-var">'k</span></code></td></tr></table><code></code></div><div class="doc"></div></div><div class="spec val" id="val-op_to_yojson"><a href="#val-op_to_yojson" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>op_to_yojson : k v. (<span class="type-var">'k</span> <span class="keyword">&#8209;&gt;</span> Yojson.Safe.json) <span class="keyword">&#8209;&gt;</span> (<span class="type-var">'v</span> <span class="keyword">&#8209;&gt;</span> Yojson.Safe.json) <span class="keyword">&#8209;&gt;</span> (<span class="type-var">'k</span>, <span class="type-var">'v</span>) <a href="index.html#type-op">op</a> <span class="keyword">&#8209;&gt;</span> Yojson.Safe.json</code></div><div class="doc"></div></div><div class="spec val" id="val-op_of_yojson"><a href="#val-op_of_yojson" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>op_of_yojson : k v. (Yojson.Safe.json <span class="keyword">&#8209;&gt;</span> <span class="type-var">'k</span> Ppx_deriving_yojson_runtime.error_or) <span class="keyword">&#8209;&gt;</span> (Yojson.Safe.json <span class="keyword">&#8209;&gt;</span> <span class="type-var">'v</span> Ppx_deriving_yojson_runtime.error_or) <span class="keyword">&#8209;&gt;</span> Yojson.Safe.json <span class="keyword">&#8209;&gt;</span> (<span class="type-var">'k</span>, <span class="type-var">'v</span>) <a href="index.html#type-op">op</a> Ppx_deriving_yojson_runtime.error_or</code></div><div class="doc"></div></div><div class="spec val" id="val-op2k"><a href="#val-op2k" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>op2k : (<span class="type-var">'a</span>, <span class="type-var">'b</span>) <a href="index.html#type-op">op</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'a</span></code></div><div class="doc"></div></div></details></div><div class="spec include"><div class="doc"></div><details open="open"><summary><span class="def"><code><span class="keyword">include </span><a href="../index.html#module-Pl_types">Pl_types</a></code></span></summary><div class="spec type" id="type-pl_node"><a href="#type-pl_node" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>('ptr, 'a) pl_node</code><code></code><code><span class="keyword"> = </span></code><code>{</code><table class="record"><tr id="type-pl_node.next" class="anchored"><td class="def field"><a href="#type-pl_node.next" class="anchor"></a><code>next : <span class="type-var">'ptr</span> option;</code></td></tr><tr id="type-pl_node.contents" class="anchored"><td class="def field"><a href="#type-pl_node.contents" class="anchor"></a><code>contents : <span class="type-var">'a</span>;</code></td></tr></table><code>}</code><code></code></div><div class="doc"><p>The type of persistent list nodes with value<code class="code">'a</code> for each node; a
singly-linked list.</p><p>Nodes in the list have an optional next pointer, and contents.</p></div></div><div class="spec type" id="type-pl_state"><a href="#type-pl_state" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>('ptr, 'a) pl_state</code><code></code><code><span class="keyword"> = </span></code><code>{</code><table class="record"><tr id="type-pl_state.current_ptr" class="anchored"><td class="def field"><a href="#type-pl_state.current_ptr" class="anchor"></a><code>current_ptr : <span class="type-var">'ptr</span>;</code></td></tr><tr id="type-pl_state.current_node" class="anchored"><td class="def field"><a href="#type-pl_state.current_node" class="anchor"></a><code>current_node : (<span class="type-var">'ptr</span>, <span class="type-var">'a</span>) <a href="index.html#type-pl_node">pl_node</a>;</code></td></tr></table><code>}</code><code></code></div><div class="doc"><p>The persistent list state. Consists of <code class="code">current_ptr</code>, a pointer to
a block that is currently being written, and <code class="code">current_node</code>, the
abstract representation of the contents of the node.</p></div></div><div class="spec type" id="type-pl_ops"><a href="#type-pl_ops" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>('a, 'ptr, 't) pl_ops</code><code></code><code><span class="keyword"> = </span></code><code>{</code><table class="record"><tr id="type-pl_ops.replace_last" class="anchored"><td class="def field"><a href="#type-pl_ops.replace_last" class="anchor"></a><code>replace_last : <span class="type-var">'a</span> <span class="keyword">&#8209;&gt;</span> (unit, <span class="type-var">'t</span>) <a href="../../../tjr_monad/Tjr_monad/Types/index.html#type-m">Tjr_monad.Types.m</a>;</code></td></tr><tr id="type-pl_ops.new_node" class="anchored"><td class="def field"><a href="#type-pl_ops.new_node" class="anchor"></a><code>new_node : <span class="type-var">'a</span> <span class="keyword">&#8209;&gt;</span> (<span class="type-var">'ptr</span>, <span class="type-var">'t</span>) <a href="../../../tjr_monad/Tjr_monad/Types/index.html#type-m">Tjr_monad.Types.m</a>;</code></td></tr></table><code>}</code><code></code></div><div class="doc"><p>The operations provided by the persistent list. <code class="code">replace_last</code>
replaces the contents of the last element of the list. <code class="code">new_node</code>
allocates a new node at the end of the list and makes it the
&quot;current&quot; node.</p></div></div></details></div><div class="spec include"><div class="doc"></div><details open="open"><summary><span class="def"><code><span class="keyword">include </span><a href="../index.html#module-Pcl_types">Pcl_types</a></code></span></summary><div class="spec type" id="type-pcl_state"><a href="#type-pcl_state" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>('e, 'repr) pcl_state</code><code></code><code><span class="keyword"> = </span></code><code>{</code><table class="record"><tr id="type-pcl_state.elts" class="anchored"><td class="def field"><a href="#type-pcl_state.elts" class="anchor"></a><code>elts : <span class="type-var">'e</span> list;</code></td></tr><tr id="type-pcl_state.elts_repr" class="anchored"><td class="def field"><a href="#type-pcl_state.elts_repr" class="anchor"></a><code>elts_repr : <span class="type-var">'repr</span>;</code></td></tr></table><code>}</code><code></code></div><div class="doc"><p>The persistent chunked list (pcl) state.</p><p>NOTE that <code class="code">'repr</code> is the type for the representation of a list of elements.</p></div></div><div class="spec type" id="type-repr_ops"><a href="#type-repr_ops" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>('e, 'repr) repr_ops</code><code></code><code><span class="keyword"> = </span></code><code>{</code><table class="record"><tr id="type-repr_ops.nil" class="anchored"><td class="def field"><a href="#type-repr_ops.nil" class="anchor"></a><code>nil : <span class="type-var">'repr</span>;</code></td></tr><tr id="type-repr_ops.snoc" class="anchored"><td class="def field"><a href="#type-repr_ops.snoc" class="anchor"></a><code>snoc : <span class="type-var">'e</span> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'repr</span> <span class="keyword">&#8209;&gt;</span> [ `Ok of <span class="type-var">'repr</span> | `Error_too_large ];</code></td></tr><tr id="type-repr_ops.repr_to_list" class="anchored"><td class="def field"><a href="#type-repr_ops.repr_to_list" class="anchor"></a><code>repr_to_list : <span class="type-var">'repr</span> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'e</span> list;</code></td></tr></table><code>}</code><code></code></div><div class="doc"><p>Routines for marshalling elements to disk. <code class="code">'repr</code> is the
underlying representation type; <code class="code">'e</code> is the element type. Note that
<code class="code">snoc</code> (join element at end of list) takes an element and the <em>representation</em> of the current node.</p></div></div><div class="spec type" id="type-inserted_type"><a href="#type-inserted_type" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>'ptr inserted_type</code><code></code><code><span class="keyword"> = </span></code><table class="variant"><tr id="type-inserted_type.Inserted_in_current_node" class="anchored"><td class="def constructor"><a href="#type-inserted_type.Inserted_in_current_node" class="anchor"></a><code><span class="keyword">| </span></code><code><span class="constructor">Inserted_in_current_node</span></code></td></tr><tr id="type-inserted_type.Inserted_in_new_node" class="anchored"><td class="def constructor"><a href="#type-inserted_type.Inserted_in_new_node" class="anchor"></a><code><span class="keyword">| </span></code><code><span class="constructor">Inserted_in_new_node</span><span class="keyword"> of </span><span class="type-var">'ptr</span></code></td></tr></table><code></code></div><div class="doc"><p>A type that records whether an element was inserted in the current
node, or whether a new node was allocated to hold the element.</p></div></div><div class="spec type" id="type-pcl_ops"><a href="#type-pcl_ops" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>('e, 'ptr, 't) pcl_ops</code><code></code><code><span class="keyword"> = </span></code><code>{</code><table class="record"><tr id="type-pcl_ops.insert" class="anchored"><td class="def field"><a href="#type-pcl_ops.insert" class="anchor"></a><code>insert : <span class="type-var">'e</span> <span class="keyword">&#8209;&gt;</span> (<span class="type-var">'ptr</span> <a href="index.html#type-inserted_type">inserted_type</a>, <span class="type-var">'t</span>) <a href="../../../tjr_monad/Tjr_monad/Types/index.html#type-m">Tjr_monad.Types.m</a>;</code></td></tr></table><code>}</code><code></code></div><div class="doc"><p>The interface exposed by the persistent chunked list, a single
<code class="code">insert</code> function.</p></div></div></details></div><div class="spec include"><div class="doc"></div><details open="open"><summary><span class="def"><code><span class="keyword">include </span><a href="../index.html#module-Dcl_types">Dcl_types</a></code></span></summary><p>The DCL types</p><div class="spec type" id="type-kvop_map_ops"><a href="#type-kvop_map_ops" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>('k, 'v, 'map) kvop_map_ops</code><code><span class="keyword"> = </span>(<span class="type-var">'k</span>, (<span class="type-var">'k</span>, <span class="type-var">'v</span>) <a href="../Ins_del_op_type/index.html#type-op">Ins_del_op_type.op</a>, <span class="type-var">'map</span>) <a href="../../../tjr_lib_core/Tjr_map/index.html#type-map_ops">Tjr_map.map_ops</a></code><code></code></div><div class="doc"><p>The type for the abstract view of the DCL. Also required by the
make_dcl_ops function. NOTE the values are ('k,'v)op, not 'v.</p></div></div><div class="spec type" id="type-detach_result"><a href="#type-detach_result" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>('ptr, 'map) detach_result</code><code></code><code><span class="keyword"> = </span></code><code>{</code><table class="record"><tr id="type-detach_result.old_ptr" class="anchored"><td class="def field"><a href="#type-detach_result.old_ptr" class="anchor"></a><code>old_ptr : <span class="type-var">'ptr</span>;</code></td></tr><tr id="type-detach_result.old_map" class="anchored"><td class="def field"><a href="#type-detach_result.old_map" class="anchor"></a><code>old_map : <span class="type-var">'map</span>;</code></td></tr><tr id="type-detach_result.new_ptr" class="anchored"><td class="def field"><a href="#type-detach_result.new_ptr" class="anchor"></a><code>new_ptr : <span class="type-var">'ptr</span>;</code></td></tr><tr id="type-detach_result.new_map" class="anchored"><td class="def field"><a href="#type-detach_result.new_map" class="anchor"></a><code>new_map : <span class="type-var">'map</span>;</code></td></tr></table><code>}</code><code></code></div><div class="doc"><p>The return type of the detach operation</p></div></div><div class="spec type" id="type-dcl_ops"><a href="#type-dcl_ops" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>('k, 'v, 'map, 'ptr, 't) dcl_ops</code><code></code><code><span class="keyword"> = </span></code><code>{</code><table class="record"><tr id="type-dcl_ops.find" class="anchored"><td class="def field"><a href="#type-dcl_ops.find" class="anchor"></a><code>find : <span class="type-var">'k</span> <span class="keyword">&#8209;&gt;</span> ((<span class="type-var">'k</span>, <span class="type-var">'v</span>) <a href="../Ins_del_op_type/index.html#type-op">Ins_del_op_type.op</a> option, <span class="type-var">'t</span>) <a href="../../../tjr_monad/Tjr_monad/Types/index.html#type-m">Tjr_monad.Types.m</a>;</code></td></tr><tr id="type-dcl_ops.add" class="anchored"><td class="def field"><a href="#type-dcl_ops.add" class="anchor"></a><code>add : (<span class="type-var">'k</span>, <span class="type-var">'v</span>) <a href="../Ins_del_op_type/index.html#type-op">Ins_del_op_type.op</a> <span class="keyword">&#8209;&gt;</span> (unit, <span class="type-var">'t</span>) <a href="../../../tjr_monad/Tjr_monad/Types/index.html#type-m">Tjr_monad.Types.m</a>;</code></td></tr><tr id="type-dcl_ops.detach" class="anchored"><td class="def field"><a href="#type-dcl_ops.detach" class="anchor"></a><code>detach : unit <span class="keyword">&#8209;&gt;</span> ((<span class="type-var">'ptr</span>, <span class="type-var">'map</span>) <a href="index.html#type-detach_result">detach_result</a>, <span class="type-var">'t</span>) <a href="../../../tjr_monad/Tjr_monad/Types/index.html#type-m">Tjr_monad.Types.m</a>;</code></td></tr><tr id="type-dcl_ops.block_list_length" class="anchored"><td class="def field"><a href="#type-dcl_ops.block_list_length" class="anchor"></a><code>block_list_length : unit <span class="keyword">&#8209;&gt;</span> (int, <span class="type-var">'t</span>) <a href="../../../tjr_monad/Tjr_monad/Types/index.html#type-m">Tjr_monad.Types.m</a>;</code></td></tr></table><code>}</code><code></code></div><div class="doc"><p>The DCL ops, <code class="code">find</code>, <code class="code">add</code>, <code class="code">detach</code> and <code class="code">block_list_length</code>.</p><p><code class="code">detach</code> indicates that we should start a new cache from the
current block. The return result is the ptr and map corresponding
to the contents of everything up to the current block, and the ptr
and map for the current block. The intention is that the detached
part is then rolled into the B-tree. If we only have 1 block, then
nothing is rolled up. This occurs when <code class="code">old_ptr</code> is the same as
<code class="code">new_ptr</code> FIXME use a new type</p><p>NOTE <code class="code">block_list_length</code>: this is the number of blocks from the
underlying chunked list, used to store the ops (not the
representation of the map! since there may be two ops -- ins and
del -- with the same key)</p><p>NOTE detach returns: 'ptr to first block in list; map upto current
node; 'ptr to current node; map for current node</p></div></div><div class="spec type" id="type-dcl_state"><a href="#type-dcl_state" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>('map, 'ptr) dcl_state</code><code></code><code><span class="keyword"> = </span></code><code>{</code><table class="record"><tr id="type-dcl_state.start_block" class="anchored"><td class="def field"><a href="#type-dcl_state.start_block" class="anchor"></a><code>start_block : <span class="type-var">'ptr</span>;</code></td></tr><tr id="type-dcl_state.current_block" class="anchored"><td class="def field"><a href="#type-dcl_state.current_block" class="anchor"></a><code>current_block : <span class="type-var">'ptr</span>;</code></td></tr><tr id="type-dcl_state.block_list_length" class="anchored"><td class="def field"><a href="#type-dcl_state.block_list_length" class="anchor"></a><code>block_list_length : int;</code></td></tr><tr id="type-dcl_state.map_past" class="anchored"><td class="def field"><a href="#type-dcl_state.map_past" class="anchor"></a><code>map_past : <span class="type-var">'map</span>;</code></td></tr><tr id="type-dcl_state.map_current" class="anchored"><td class="def field"><a href="#type-dcl_state.map_current" class="anchor"></a><code>map_current : <span class="type-var">'map</span>;</code></td></tr></table><code>}</code><code></code></div><div class="doc"><p>The state of the DCL. Parameters are:</p><ul><li><code class="code">start_block</code> is the root of the log</li><li><code class="code">current_block</code> is the current block being written to</li><li><code class="code">map_past</code> is the map from root to just before <code class="code">current_block</code></li><li><code class="code">map_current</code> is the map for the current block</li></ul></div></div></details></div></body></html>