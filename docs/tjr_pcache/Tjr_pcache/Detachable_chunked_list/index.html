<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Detachable_chunked_list (tjr_pcache.Tjr_pcache.Detachable_chunked_list)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="generator" content="doc-ock-html v1.0.0-1-g1fc9bf0"/></head><body><nav id="top"><a href="../index.html">Up</a> &mdash; <span class="package">package <a href="../../index.html">tjr_pcache</a></span></nav><header><h1><span class="keyword">Module</span> <span class="module-path">Tjr_pcache.Detachable_chunked_list</span></h1></header><p>A &quot;detachable list&quot;, with an operation <code class="code">detach</code> to drop everything but the current node.</p><p>NOTE this code is not concurrent safe. Access must be serialized.</p><div class="spec include"><div class="doc"></div><details open="open"><summary><span class="def"><code><span class="keyword">include </span><a href="../index.html#module-Dcl_types">Dcl_types</a></code></span></summary><p>The DCL types</p><div class="spec type" id="type-abs_ops"><a href="#type-abs_ops" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>('op, 'abs) abs_ops</code><code></code><code><span class="keyword"> = </span></code><code>{</code><table class="record"><tr id="type-abs_ops.empty" class="anchored"><td class="def field"><a href="#type-abs_ops.empty" class="anchor"></a><code>empty : <span class="type-var">'abs</span>;</code></td></tr><tr id="type-abs_ops.add" class="anchored"><td class="def field"><a href="#type-abs_ops.add" class="anchor"></a><code>add : <span class="type-var">'op</span> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'abs</span> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'abs</span>;</code></td></tr><tr id="type-abs_ops.merge" class="anchored"><td class="def field"><a href="#type-abs_ops.merge" class="anchor"></a><code>merge : <span class="type-var">'abs</span> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'abs</span> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'abs</span>;</code></td></tr></table><code>}</code><code></code></div><div class="doc"><p>Operations on the &quot;abstract&quot; state. The pcl state is something like a list of map operations. The 'abs type is something like the &quot;map&quot; view of these operations (needed because the list is redundant, or at the very least inefficient for map operations). Type vars:</p><ul><li><code class="code">'op</code> is eg insert(k,v), delete(k)</li><li>'abs is the &quot;abstraction&quot;</li></ul><p>Operations:</p><ul><li>empty, the empty map</li><li>add, to add an operation to the abstract state</li><li>merge, to merge two maps (second takes precedence); used when a new node is created, and the old node is merged into the accumulated past nodes.</li></ul></div></div><div class="spec val" id="val-abs_singleton"><a href="#val-abs_singleton" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>abs_singleton : abs_ops:(<span class="type-var">'a</span>, <span class="type-var">'b</span>) <a href="index.html#type-abs_ops">abs_ops</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'a</span> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'b</span></code></div><div class="doc"></div></div><div class="spec type" id="type-dcl_state"><a href="#type-dcl_state" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>('ptr, 'abs) dcl_state</code><code></code><code><span class="keyword"> = </span></code><code>{</code><table class="record"><tr id="type-dcl_state.start_block" class="anchored"><td class="def field"><a href="#type-dcl_state.start_block" class="anchor"></a><code>start_block : <span class="type-var">'ptr</span>;</code></td></tr><tr id="type-dcl_state.current_block" class="anchored"><td class="def field"><a href="#type-dcl_state.current_block" class="anchor"></a><code>current_block : <span class="type-var">'ptr</span>;</code></td></tr><tr id="type-dcl_state.block_list_length" class="anchored"><td class="def field"><a href="#type-dcl_state.block_list_length" class="anchor"></a><code>block_list_length : int;</code></td></tr><tr id="type-dcl_state.abs_past" class="anchored"><td class="def field"><a href="#type-dcl_state.abs_past" class="anchor"></a><code>abs_past : <span class="type-var">'abs</span>;</code></td></tr><tr id="type-dcl_state.abs_current" class="anchored"><td class="def field"><a href="#type-dcl_state.abs_current" class="anchor"></a><code>abs_current : <span class="type-var">'abs</span>;</code></td></tr></table><code>}</code><code></code></div><div class="doc"><p>The state of the DCL. Fields are:</p><ul><li><code class="code">start_block</code> is the root of the log</li><li><code class="code">current_block</code> is the current block being written to</li><li><code class="code">abs_past</code> is the abstract view of ops from root to just before <code class="code">current_block</code></li><li><code class="code">abs_current</code> is the abstract view of ops for the current block</li></ul><p>NOTE unlike Pl and Pcl, we have a concrete type for the state, since
we don't expect to have any extra info stored at this point. (FIXME what about dcl_dummy_implementation where we need to store all ptrs?) But
perhaps we can avoid some of these extra type params if we keep dcl
state abstract as <code class="code">'dcl_state</code>. But this seems unlikely.</p><p>NOTE <code class="code">block_list_length</code>: this is the number of blocks from the
underlying chunked list, used to store the ops (not the
abstract representation!)</p><p>NOTE upto this point, the pl and the pcl have not explicitly tracked the start of the list. FIXME perhaps they should? This has advantages in that the abstraction is self-contained.</p></div></div><div class="spec type" id="type-dcl_ops"><a href="#type-dcl_ops" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>('op, 'abs, 'ptr, 't) dcl_ops</code><code></code><code><span class="keyword"> = </span></code><code>{</code><table class="record"><tr id="type-dcl_ops.add" class="anchored"><td class="def field"><a href="#type-dcl_ops.add" class="anchor"></a><code>add : <span class="type-var">'op</span> <span class="keyword">&#8209;&gt;</span> (unit, <span class="type-var">'t</span>) <a href="../../../tjr_monad/Tjr_monad/Types/index.html#type-m">Tjr_monad.Types.m</a>;</code></td></tr><tr id="type-dcl_ops.peek" class="anchored"><td class="def field"><a href="#type-dcl_ops.peek" class="anchor"></a><code>peek : unit <span class="keyword">&#8209;&gt;</span> ((<span class="type-var">'ptr</span>, <span class="type-var">'abs</span>) <a href="index.html#type-dcl_state">dcl_state</a>, <span class="type-var">'t</span>) <a href="../../../tjr_monad/Tjr_monad/Types/index.html#type-m">Tjr_monad.Types.m</a>;</code></td></tr><tr id="type-dcl_ops.detach" class="anchored"><td class="def field"><a href="#type-dcl_ops.detach" class="anchor"></a><code>detach : unit <span class="keyword">&#8209;&gt;</span> ((<span class="type-var">'ptr</span>, <span class="type-var">'abs</span>) <a href="index.html#type-dcl_state">dcl_state</a>, <span class="type-var">'t</span>) <a href="../../../tjr_monad/Tjr_monad/Types/index.html#type-m">Tjr_monad.Types.m</a>;</code></td></tr><tr id="type-dcl_ops.block_list_length" class="anchored"><td class="def field"><a href="#type-dcl_ops.block_list_length" class="anchor"></a><code>block_list_length : unit <span class="keyword">&#8209;&gt;</span> (int, <span class="type-var">'t</span>) <a href="../../../tjr_monad/Tjr_monad/Types/index.html#type-m">Tjr_monad.Types.m</a>;</code></td></tr></table><code>}</code><code></code></div><div class="doc"><p>The DCL ops:</p><ul><li><code class="code">add</code> to add an op</li><li><code class="code">peek</code> to reveal the dcl_state (FIXME why?)</li><li><code class="code">detach</code> to issue a detach operation (eg prior to rolling the past entries into a B-tree)</li><li><code class="code">block_list_length</code> to provide information to help determine when to roll up</li></ul><p>The <code class="code">detach</code> operation means that we should start a new cache from the
current block.</p><p>The return result is the ptr and map corresponding
to the contents of everything up to the current block, and the ptr
and map for the current block. The intention is that the detached
part is then rolled into the B-tree. If we only have 1 block, then
nothing is rolled up. This occurs when <code class="code">old_ptr</code> is the same as
<code class="code">new_ptr</code> FIXME use a new type</p><p>NOTE detach returns the dcl_state since this includes at least all the fields we need.</p></div></div></details></div><div class="spec val" id="val-make_dcl_ops"><a href="#val-make_dcl_ops" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>make_dcl_ops : monad_ops:<span class="type-var">'t</span> <a href="../../../tjr_monad/Tjr_monad/Types/index.html#type-monad_ops">Tjr_monad.Types.monad_ops</a> <span class="keyword">&#8209;&gt;</span> pcl_ops:(<span class="type-var">'op</span>, <span class="type-var">'ptr</span>, <span class="type-var">'t</span>) <a href="../Pcl_types/index.html#type-pcl_ops">Pcl_types.pcl_ops</a> <span class="keyword">&#8209;&gt;</span> with_dcl:((<span class="type-var">'ptr</span>, <span class="type-var">'abs</span>) <a href="index.html#type-dcl_state">dcl_state</a>, <span class="type-var">'t</span>) <a href="../../../tjr_monad/Tjr_monad/With_state/index.html#type-with_state">Tjr_monad.With_state.with_state</a> <span class="keyword">&#8209;&gt;</span> abs_ops:(<span class="type-var">'op</span>, <span class="type-var">'abs</span>) <a href="index.html#type-abs_ops">abs_ops</a> <span class="keyword">&#8209;&gt;</span> (<span class="type-var">'op</span>, <span class="type-var">'abs</span>, <span class="type-var">'ptr</span>, <span class="type-var">'t</span>) <a href="index.html#type-dcl_ops">dcl_ops</a></code></div><div class="doc"><p>Construct the dcl operations. Parameters:</p><ul><li><code class="code">monad_ops</code>, the monadic operations</li><li><code class="code">pcl_ops</code>, the persistent chunked list ops</li><li><code class="code">with_dcl</code>, access the dcl state</li><li><code class="code">abs_ops</code>, operations on the abstract data (see <a href="../Detachable_map/index.html">Detachable_map</a> for an example where the abstract data is a map)</li></ul></div></div></body></html>